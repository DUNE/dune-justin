cat <<EOF >rucio.cfg
[client]
rucio_host = https://dune-rucio.fnal.gov
auth_host = https://auth-dune-rucio.fnal.gov
account = dunepro
auth_type = x509_proxy
request_retries = 3
EOF

source /cvmfs/dune.opensciencegrid.org/products/dune/setup_dune.sh
setup rucio
rucio --config rucio.cfg --version

touch results.txt
export now=`date +'%s'`

cat $WFS_PATH/wfs-all-rse-list.txt | (

while read rse_name write_protocol
do
  echo $WFS_SITE_NAME $rse_name $write_protocol

  # Test download of file prepositioned on all RSEs
  rucio --config rucio.cfg \
        --verbose \
        download \
        --protocol root \
        --rse "$rse_name" \
        --transfer-timeout 600 \
        "testpro:wtf-download-file.txt"
  download_retval=$?

  # Test upload of random file
  fn=`mktemp wtf-$now-XXXXXXXXXX`
  echo "$fn" > $fn

  rucio --config rucio.cfg \
        --verbose \
        upload \
        --rse "$rse_name" \
        --transfer-timeout 600 \
        --protocol "$write_protocol" \
        --scope testpro \
        --name "$fn" "$fn"

  upload_retval=$?

  echo "==wtf== $WFS_SITE_NAME $rse_name $download_retval $upload_retval" \
    >> results.txt
done

)

echo "Testing results:"
cat results.txt
