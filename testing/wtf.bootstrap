cat <<EOF >rucio.cfg
[client]
rucio_host = https://dune-rucio.fnal.gov
auth_host = https://auth-dune-rucio.fnal.gov
account = dunepro
auth_type = x509_proxy
request_retries = 3
EOF

source /cvmfs/dune.opensciencegrid.org/products/dune/setup_dune.sh
setup rucio
rucio --config rucio.cfg --version

touch results.txt
export now=`date +'%s'`

cat $WFS_PATH/wfs-wtf-rse-list.txt | (

while read rse_name write_protocol read_pfn
do
  echo $WFS_SITE_NAME $rse_name $write_protocol $read_pfn

  # Test download of file prepositioned on RSEs
  xrdcp --force --nopbar --verbose "$read_pfn" wtf-download-file.txt
  download_retval=$?
  echo "'xrdcp --force --nopbar --verbose $read_pfn wtf-download-file.txt' returns $download_retval"

  # Test upload of random file
  fn=`mktemp wtf-$now-XXXXXXXXXX`
  echo "$fn" > $fn

  rucio --config rucio.cfg \
        --verbose \
        upload \
        --rse "$rse_name" \
        --protocol "$write_protocol" \
        --scope testpro \
        --name "$fn" "$fn"

  upload_retval=$?

  echo "==wtf== $WFS_SITE_NAME $rse_name $download_retval $upload_retval" \
    "$read_pfn $write_protocol" >> results.txt
done

)

echo
echo '===== Results ====='
echo
echo 'Download/upload commands:'
echo 'xrdcp --force --nopbar --verbose $read_pfn wtf-download-file.txt'
echo 'rucio --config rucio.cfg --verbose upload --rse $rse_name --protocol $write_protocol --scope testpro --name FILENAME FILENAME'
echo
echo 'Each line: $WFS_SITE_NAME $rse_name $download_retval $upload_retval $read_pfn $write_protocol'
cat results.txt
