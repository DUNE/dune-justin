#!/bin/sh
:<<'EOF'
justin simple-workflow \
  --rss-mb 2000 \
  --mql 'rucio-dataset testpro:awt' \
  --jobscript awt.jobscript
EOF

source /cvmfs/dune.opensciencegrid.org/products/dune/setup_dune.sh
setup rucio
setup justin
unset GFAL_CONFIG_DIR GFAL_PLUGIN_DIR
export X509_USER_PROXY=$JUSTIN_PATH/awt-proxy.pem
which rucio
rucio --version
python3 -c 'import gfal2 ; print("gfal version",gfal2.get_version())'

touch results.txt
export now=`date +'%s'`

echo '===Start $JUSTIN_PATH/justin-awt-rse-list.txt==='
cat "$JUSTIN_PATH/justin-awt-rse-list.txt"
echo '===End $JUSTIN_PATH/justin-awt-rse-list.txt==='

cat $JUSTIN_PATH/justin-awt-rse-list.txt | (

while read rse_name write_protocol read_pfn
do
  echo '---------------------------------------------------------------------'
  echo $JUSTIN_SITE_NAME $rse_name $write_protocol $read_pfn

  # Test download of file prepositioned on RSEs
  xrdcp --force --nopbar --verbose "$read_pfn" "downloaded.txt"
  download_retval=$?

  echo "'xrdcp --force --nopbar --verbose $read_pfn downloaded.txt' returns $download_retval"

  # Test upload of random file
  fn=`mktemp awt-$now-XXXXXXXXXX`
  echo "$fn" > $fn

  echo "GFAL_CONFIG_DIR: $GFAL_CONFIG_DIR   GFAL_PLUGIN_DIR: $GFAL_PLUGIN_DIR"
  for i in 1 2 3 4 5
  do
    echo "justin-rucio-upload attempt $i"
    justin-rucio-upload \
            --rse "$rse_name" \
            --protocol "$write_protocol" \
            --scope testpro \
            --dataset awt-uploads \
            --timeout 1200 \
            "$fn" 2>&1 
#            | sed -r 's/\x1B\[([0-9]{1,3}(;[0-9]{1,2};?)?)?[mGK]//g'
    upload_retval=$?
    if [ $upload_retval != 63 ] ; then
      break
    fi
  done

  echo "'justin-rucio-upload --rse $rse_name --protocol $write_protocol --scope testpro --dataset awt-uploads $fn --timeout 1200' returns $upload_retval"
  echo
  echo

  echo "==awt== $JUSTIN_SITE_NAME $rse_name $download_retval $upload_retval" \
    "$read_pfn $write_protocol" >> results.txt

done

)

voms-proxy-info --all --file $X509_USER_PROXY

echo
echo '===== Results ====='
echo
echo 'Download/upload commands:'
echo 'xrdcp --force --nopbar --verbose $read_pfn downloaded.txt'
echo 'justin-rucio-upload --rse $rse_name --protocol $write_protocol --scope testpro --dataset awt-uploads --timeout 1200 FILENAME'
echo 'Use the wrapper job link on the page for the job on the justIN Dashboard to find the full log file, with errors from these commands'
echo
echo 'Each line: $JUSTIN_SITE_NAME $rse_name $download_retval $upload_retval $read_pfn $write_protocol'
cat results.txt
