#cat <<EOF >rucio.cfg
#[client]
#rucio_host = https://dune-rucio.fnal.gov
#auth_host = https://auth-dune-rucio.fnal.gov
#account = dunepro
#auth_type = x509_proxy
#request_retries = 3
#EOF

source /cvmfs/dune.opensciencegrid.org/products/dune/setup_dune.sh
setup rucio
which rucio
#rucio --config rucio.cfg --version
rucio --version
python3 -c 'import gfal2 ; print("gfal version",gfal2.get_version())'

touch results.txt
export now=`date +'%s'`

cat $JUSTIN_PATH/justin-awt-rse-list.txt | (

while read rse_name write_protocol read_pfn
do
  echo $JUSTIN_SITE_NAME $rse_name $write_protocol $read_pfn

  # Test download of file prepositioned on RSEs
  xrdcp --force --nopbar --verbose "$read_pfn" awt-download-file.txt
  download_retval=$?
  echo "'xrdcp --force --nopbar --verbose $read_pfn awt-download-file.txt' returns $download_retval"

  # Test upload of random file
  fn=`mktemp awt-$now-XXXXXXXXXX`
  echo "$fn" > $fn

  rucio --verbose \
        upload \
        --rse "$rse_name" \
        --protocol "$write_protocol" \
        --scope testpro \
        --lifetime 86400 \
        --name "$fn" "$fn"

  upload_retval=$?
  echo "rucio --verbose upload --rse $rse_name --protocol $write_protocol --scope testpro --lifetime 86400 --name $fn $fn' returns $upload_retval"

  echo "==awt== $JUSTIN_SITE_NAME $rse_name $download_retval $upload_retval" \
    "$read_pfn $write_protocol" >> results.txt
done

)

echo
echo '===== Results ====='
echo
echo 'Download/upload commands:'
echo 'xrdcp --force --nopbar --verbose $read_pfn awt-download-file.txt'
echo 'rucio --verbose upload --rse $rse_name --protocol $write_protocol --scope testpro --name FILENAME FILENAME'
echo
echo 'Each line: $JUSTIN_SITE_NAME $rse_name $download_retval $upload_retval $read_pfn $write_protocol'
cat results.txt
